<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Users</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
.topbar{position:fixed;top:0;left:0;width:100%;height:60px;background:#111827;display:flex;align-items:center;padding:0 20px;z-index:1001;}
.topbar h1{margin:0;font-size:18px;}
.sidebar{position:fixed;top:60px;left:0;width:260px;height:calc(100vh-60px);background:#111827;padding:15px;overflow-y:auto;}
.sidebar ul{list-style:none;padding:0;margin:0;}
.sidebar li{margin:10px 0;}
.sidebar a{display:block;padding:10px;color:#fff;text-decoration:none;border-radius:6px;}
.sidebar a:hover{background:#38bdf8;color:#000;}
.main{margin-left:260px;margin-top:60px;padding:15px;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #38bdf8;padding:8px;text-align:center;}
th{background:#1f2937;}
button{padding:5px 10px;border:none;border-radius:6px;background:#38bdf8;color:#0b0f1a;font-weight:bold;cursor:pointer;margin:2px;}
input{width:60px;padding:3px;border-radius:4px;border:none;text-align:center;}
</style>
</head>
<body>

<div class="topbar"><h1>Admin - Users</h1></div>
<div class="sidebar">
<ul>
<li><a href="admin-dashboard.html">Dashboard</a></li>
<li><a href="admin-users.html">Users</a></li>
<li><a href="admin-deposits.html">Deposits</a></li>
<li><a href="admin-withdraws.html">Withdraws</a></li>
<li><a href="admin-nfts.html">NFTs</a></li>
<li><a href="admin-login.html" id="logoutBtn">Logout</a></li>
</ul>
</div>

<div class="main">
<h2>All Users</h2>
<table>
<thead>
<tr>
<th>Email</th>
<th>Level</th>
<th>Balance</th>
<th>Freeze</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyB4SGtNZL0N4TIoJ1bGbkiAeRWJcQgrF-4",
authDomain: "supernft-5b952.firebaseapp.com",
projectId: "supernft-5b952",
storageBucket: "supernft-5b952.appspot.com",
messagingSenderId: "278097730700",
appId: "1:278097730700:web:6ba9892334456fd8512fa9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Login guard + admin role check
onAuthStateChanged(auth, async user=>{
  if(!user) return window.location.replace("admin-login.html");
  const snap = await getDoc(doc(db,"admins",user.uid));
  if(!snap.exists()) return window.location.replace("admin-login.html");
  loadUsers();
});

// Logout
document.getElementById("logoutBtn").addEventListener("click",()=>signOut(auth).then(()=>window.location.replace("admin-login.html")));

// Load Users
async function loadUsers(){
  const usersSnap = await getDocs(collection(db,"users"));
  const tbody = document.getElementById("userTable");
  tbody.innerHTML="";
  usersSnap.forEach(u=>{
    const data = u.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${data.email||u.id}</td>
      <td><input value="${data.level||'Starter'}" id="level-${u.id}"></td>
      <td>${calculateBalance(data)}</td>
      <td><button onclick="toggleFreeze('${u.id}',${data.isFrozen||false})">${data.isFrozen?"Unfreeze":"Freeze"}</button></td>
      <td><button onclick="updateLevel('${u.id}')">Update Level</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Balance calculation
function calculateBalance(data){
  const deposits = (data.deposits||[]).reduce((s,d)=>s+d.amount,0);
  const withdrawals = (data.withdrawals||[]).reduce((s,w)=>s+w.amount,0);
  const nftEarnings = (data.nfts||[]).reduce((sum,n)=>{
    const days = Math.floor((Date.now() - n.boughtAt.toDate().getTime())/(1000*60*60*24));
    return sum + n.price*(n.dailyPercent/100)*days;
  },0);
  return (deposits - withdrawals + nftEarnings).toFixed(2);
}

// Update user level
async function updateLevel(uid){
  const newLevel = document.getElementById(`level-${uid}`).value;
  await updateDoc(doc(db,"users",uid),{level:newLevel});
  alert("User level updated ✅");
}

// Freeze / unfreeze
async function toggleFreeze(uid,current){
  await updateDoc(doc(db,"users",uid),{isFrozen: !current});
  alert(current?"User unfrozen ✅":"User frozen ✅");
  loadUsers();
}
</script>
</body>
</html>
